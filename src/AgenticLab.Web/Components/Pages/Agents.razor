@page "/agents"

<style>
    fluent-dialog::part(control) {
        min-width: 1100px;
        max-width: 1200px;
    }
    fluent-dialog .fluent-dialog-body,
    fluent-dialog fluent-dialog-body {
        width: 100%;
    }
    fluent-dialog fluent-dialog-body > div {
        width: 100%;
    }
</style>

<PageTitle>AgenticLab — Agents</PageTitle>

<div class="section-header">
    <h1>Agent Configuration</h1>
</div>

<p>Create and configure agents by combining an agent type with a model configuration. Customize behavior with system prompt overrides and parameter tuning.</p>

<FluentToolbar Style="margin-bottom: 16px;">
    <FluentButton Appearance="Appearance.Accent" OnClick="ShowAddDialog">
        <FluentIcon Value="@(new Size16.Add())" Slot="start" />
        Create Agent
    </FluentButton>
</FluentToolbar>

@if (_configs.Count == 0)
{
    <FluentCard>
        <p>No agents configured yet. Click "Create Agent" to get started.</p>
    </FluentCard>
}
else
{
    <FluentDataGrid Items="@_configs.AsQueryable()" Style="width: 100%;">
        <PropertyColumn Property="@(c => c.DisplayName)" Title="Name" />
        <PropertyColumn Property="@(c => c.AgentType)" Title="Type" />
        <TemplateColumn Title="Model">
            @{
                var model = ModelRegistry.GetConfig(context.ModelConfigId);
            }
            @(model?.DisplayName ?? "Unknown")
        </TemplateColumn>
        <TemplateColumn Title="Temp Override">
            @(context.TemperatureOverride?.ToString("F1") ?? "Default")
        </TemplateColumn>
        <TemplateColumn Title="Status">
            <span class="status-dot @(context.IsActive ? "online" : "offline")"></span>
            @(context.IsActive ? "Active" : "Inactive")
        </TemplateColumn>
        <TemplateColumn Title="Prompt">
            @{
                var hasOverride = !string.IsNullOrWhiteSpace(context.SystemPromptOverride);
            }
            <FluentBadge Appearance="@(hasOverride ? Appearance.Accent : Appearance.Neutral)" Style="font-size: 0.75rem;">
                @(hasOverride ? "Custom" : "Default")
            </FluentBadge>
        </TemplateColumn>
        <TemplateColumn Title="Actions">
            <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => EditConfig(context))">
                <FluentIcon Value="@(new Size16.Edit())" />
            </FluentButton>
            <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => TestAgent(context))">
                <FluentIcon Value="@(new Size16.Play())" />
            </FluentButton>
            <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => DeleteConfig(context.Id))">
                <FluentIcon Value="@(new Size16.Delete())" />
            </FluentButton>
        </TemplateColumn>
    </FluentDataGrid>
}

<h2 style="margin-top: 32px;">Available Agent Types</h2>

<FluentStack Orientation="Orientation.Vertical" Style="gap: 16px;">
    @foreach (var agentType in AgentFactoryService.GetAvailableAgentTypes())
    {
        <FluentCard Style="width: 100%;">
            <FluentStack Orientation="Orientation.Horizontal" Style="align-items: baseline; gap: 12px; margin-bottom: 4px;">
                <h3 style="margin: 0;">@agentType.DisplayName</h3>
                <code style="font-size: 0.8rem; opacity: 0.6;">@agentType.TypeId</code>
            </FluentStack>
            <p style="margin: 4px 0 8px;">@agentType.Description</p>
            <details>
                <summary style="cursor: pointer; font-weight: 600; font-size: 0.85rem;">System Prompt</summary>
                <pre style="white-space: pre-wrap; background: var(--neutral-layer-3, #f5f5f5); padding: 12px; border-radius: 4px; margin-top: 8px; font-size: 0.85rem; line-height: 1.4;">@agentType.SystemPrompt.Trim()</pre>
            </details>
        </FluentCard>
    }
</FluentStack>

@if (_showDialog)
{
    <FluentDialog @bind-Hidden="@_hideDialog" Modal="true" TrapFocus="true" Style="min-width: 1100px; max-width: 1200px; --dialog-width: 1100px;" @ondialogdismiss="CloseDialog">
        <FluentDialogHeader>
            @(_editingConfig is null ? "Create Agent" : "Edit Agent")
        </FluentDialogHeader>
        <FluentDialogBody Style="width: 100%;">
            <FluentStack Orientation="Orientation.Vertical" Style="gap: 12px; width: 100%;">
                <FluentTextField @bind-Value="_formDisplayName" Label="Display Name" Placeholder="My Agent" Style="width: 100%;" />

                <FluentSelect TOption="string" @bind-Value="_formAgentType" Label="Agent Type" Style="width: 100%;">
                    @foreach (var at in AgentFactoryService.GetAvailableAgentTypes())
                    {
                        <FluentOption TOption="string" Value="@at.TypeId">@at.DisplayName — @at.Description</FluentOption>
                    }
                </FluentSelect>

                @{
                    var defaultPrompt = AgenticLab.Agents.SpecialistAgents.GetDefaultSystemPrompt(_formAgentType);
                }
                <details style="border: 1px solid var(--neutral-stroke-rest, #e0e0e0); border-radius: 4px; padding: 8px 12px;">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 0.85rem;">Default System Prompt</summary>
                    <div style="white-space: pre-wrap; background: var(--neutral-layer-3, #f5f5f5); padding: 12px; border-radius: 4px; margin-top: 8px; font-size: 0.85rem; font-family: inherit; line-height: 1.5; max-height: 200px; overflow-y: auto;">@defaultPrompt.Trim()</div>
                </details>

                <FluentSelect TOption="string" @bind-Value="_formModelConfigId" Label="Model Configuration" Style="width: 100%;">
                    @foreach (var mc in _modelConfigs)
                    {
                        <FluentOption TOption="string" Value="@mc.Id">@mc.DisplayName (@mc.ModelName)</FluentOption>
                    }
                </FluentSelect>

                <FluentTextArea @bind-Value="_formSystemPrompt" Label="System Prompt Override (optional)" Rows="3" Style="width: 100%;"
                    Placeholder="Leave empty to use agent's default prompt." />

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <FluentNumberField @bind-Value="_formTempOverride" Label="Temperature Override (optional)" Min="0" Max="2" Step="0.1" Style="width: 100%;" />
                    <FluentNumberField @bind-Value="_formMaxTokensOverride" Label="Max Tokens Override (optional)" Min="50" Max="32000" Step="100" Style="width: 100%;" />
                </div>

                <div style="border: 1px solid var(--neutral-stroke-rest, #e0e0e0); border-radius: 6px; padding: 16px; margin-top: 4px; background: var(--neutral-layer-2, #fafafa);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <FluentIcon Value="@(new Size16.Settings())" />
                        <h4 style="margin: 0;">Advanced Ollama Parameters</h4>
                    </div>
                    <p style="margin: 0 0 12px; font-size: 0.8rem; opacity: 0.6;">These map directly to <a href="https://docs.ollama.com/modelfile" target="_blank" rel="noopener">Ollama's model parameters</a>. Leave empty to use Ollama defaults.</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <FluentNumberField @bind-Value="_formTopPOverride" Label="Top-P (nucleus sampling)" Min="0" Max="1" Step="0.05" Style="width: 100%;" Placeholder="Default: 0.9" />
                        <FluentNumberField @bind-Value="_formTopKOverride" Label="Top-K (token candidates)" Min="1" Max="200" Step="5" Style="width: 100%;" Placeholder="Default: 40" />
                        <FluentNumberField @bind-Value="_formRepeatPenaltyOverride" Label="Repeat Penalty" Min="0" Max="3" Step="0.1" Style="width: 100%;" Placeholder="Default: 1.1" />
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <FluentNumberField @bind-Value="_formNumCtxOverride" Label="Context Window (tokens)" Min="256" Max="131072" Step="256" Style="width: 100%;" Placeholder="Default: 2048" />
                        <FluentNumberField @bind-Value="_formSeedOverride" Label="Seed (0 = random)" Min="0" Max="999999" Step="1" Style="width: 100%;" Placeholder="Default: 0" />
                    </div>
                </div>
            </FluentStack>
        </FluentDialogBody>
        <FluentDialogFooter>
            <FluentButton Appearance="Appearance.Accent" OnClick="SaveConfig">Save</FluentButton>
            <FluentButton Appearance="Appearance.Neutral" OnClick="CloseDialog">Cancel</FluentButton>
        </FluentDialogFooter>
    </FluentDialog>
}

@code {
    [Inject] private AgentFactoryService AgentFactory { get; set; } = default!;
    [Inject] private ModelRegistryService ModelRegistry { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private List<AgentConfig> _configs = [];
    private List<ModelConfig> _modelConfigs = [];
    private bool _showDialog;
    private bool _hideDialog = true;
    private AgentConfig? _editingConfig;

    // Form fields
    private string _formDisplayName = "";
    private string _formAgentType = "SimpleQuestion";
    private string _formModelConfigId = "";
    private string _formSystemPrompt = "";
    private double? _formTempOverride;
    private int? _formMaxTokensOverride;
    private double? _formTopPOverride;
    private int? _formTopKOverride;
    private double? _formRepeatPenaltyOverride;
    private int? _formNumCtxOverride;
    private int? _formSeedOverride;

    protected override void OnInitialized()
    {
        _configs = AgentFactory.GetConfigs().ToList();
        _modelConfigs = ModelRegistry.GetConfigs().ToList();
    }

    private void ShowAddDialog()
    {
        _editingConfig = null;
        _formDisplayName = "";
        _formAgentType = "SimpleQuestion";
        _formModelConfigId = _modelConfigs.Count > 0 ? _modelConfigs[0].Id : "";
        _formSystemPrompt = "";
        _formTempOverride = null;
        _formMaxTokensOverride = null;
        _formTopPOverride = null;
        _formTopKOverride = null;
        _formRepeatPenaltyOverride = null;
        _formNumCtxOverride = null;
        _formSeedOverride = null;
        _showDialog = true;
        _hideDialog = false;
    }

    private void EditConfig(AgentConfig config)
    {
        _editingConfig = config;
        _formDisplayName = config.DisplayName;
        _formAgentType = config.AgentType;
        _formModelConfigId = config.ModelConfigId;
        _formSystemPrompt = config.SystemPromptOverride ?? "";
        _formTempOverride = config.TemperatureOverride;
        _formMaxTokensOverride = config.MaxTokensOverride;
        _formTopPOverride = config.TopPOverride;
        _formTopKOverride = config.TopKOverride;
        _formRepeatPenaltyOverride = config.RepeatPenaltyOverride;
        _formNumCtxOverride = config.NumCtxOverride;
        _formSeedOverride = config.SeedOverride;
        _showDialog = true;
        _hideDialog = false;
    }

    private void SaveConfig()
    {
        if (_editingConfig is not null)
        {
            _editingConfig.DisplayName = _formDisplayName;
            _editingConfig.AgentType = _formAgentType;
            _editingConfig.ModelConfigId = _formModelConfigId;
            _editingConfig.SystemPromptOverride = string.IsNullOrWhiteSpace(_formSystemPrompt) ? null : _formSystemPrompt;
            _editingConfig.TemperatureOverride = _formTempOverride;
            _editingConfig.MaxTokensOverride = _formMaxTokensOverride;
            _editingConfig.TopPOverride = _formTopPOverride;
            _editingConfig.TopKOverride = _formTopKOverride;
            _editingConfig.RepeatPenaltyOverride = _formRepeatPenaltyOverride;
            _editingConfig.NumCtxOverride = _formNumCtxOverride;
            _editingConfig.SeedOverride = _formSeedOverride;
            AgentFactory.UpdateConfig(_editingConfig);
        }
        else
        {
            var config = new AgentConfig
            {
                DisplayName = _formDisplayName,
                AgentType = _formAgentType,
                ModelConfigId = _formModelConfigId,
                SystemPromptOverride = string.IsNullOrWhiteSpace(_formSystemPrompt) ? null : _formSystemPrompt,
                TemperatureOverride = _formTempOverride,
                MaxTokensOverride = _formMaxTokensOverride,
                TopPOverride = _formTopPOverride,
                TopKOverride = _formTopKOverride,
                RepeatPenaltyOverride = _formRepeatPenaltyOverride,
                NumCtxOverride = _formNumCtxOverride,
                SeedOverride = _formSeedOverride
            };
            AgentFactory.AddConfig(config);
        }

        _configs = AgentFactory.GetConfigs().ToList();
        CloseDialog();
    }

    private void DeleteConfig(string id)
    {
        AgentFactory.RemoveConfig(id);
        _configs = AgentFactory.GetConfigs().ToList();
    }

    private void TestAgent(AgentConfig config)
    {
        Navigation.NavigateTo($"/playground?agentId={config.Id}");
    }

    private void CloseDialog()
    {
        _showDialog = false;
        _hideDialog = true;
    }
}
